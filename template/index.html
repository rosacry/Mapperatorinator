<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapperatorinator Interface (Flask+pywebview)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <!-- Container for Flash Messages/Popups -->
    <div id="flash-container"></div>
    <div class="container">
      <main>
        <form id="inferenceForm" method="POST" class="card form-card">
          <fieldset>
            <legend>Paths</legend>
            <div class="path-input-group"> <label for="audio_path" title="Path to audio file">Audio Path:</label>
              <input type="text" id="audio_path" name="audio_path" />
              <button type="button" id="browse-audio" class="browse-button">Browse...</button>
            </div>
            <div class="path-input-group"> <label for="output_path" title="Path to output folder">Output Path:</label>
              <input type="text" id="output_path" name="output_path" />
              <button type="button" id="browse-output" class="browse-button">Browse...</button>
            </div>
            <div class="path-input-group"> <label for="beatmap_path" title="Path to .osu file to autofill metadata, audio path, and output path, or use as reference">Beatmap Path:</label>
              <input type="text" id="beatmap_path" name="beatmap_path" />
              <button type="button" id="browse-beatmap" class="browse-button">Browse...</button>
            </div>
            <!-- Start: In-Context Options Box -->
            <div id="in-context-options-box" class="context-options-box" style="display: none;">
                <h4 title="List of additional context to provide to the model">In-Context Options</h4> <!-- Title inside the box -->
                <div class="context-options-container">
                  <div class="context-option-item" data-value="NONE">
                    <input type="checkbox" id="context-none" name="in_context_options" value="NONE" />
                    <label for="context-none">None</label>
                  </div>
                  <div class="context-option-item" data-value="TIMING">
                    <input type="checkbox" id="context-timing" name="in_context_options" value="TIMING" />
                    <label for="context-timing">Timing</label>
                  </div>
                  <div class="context-option-item" data-value="KIAI">
                    <input type="checkbox" id="context-kiai" name="in_context_options" value="KIAI" />
                    <label for="context-kiai">Kiai</label>
                  </div>
                  <div class="context-option-item" data-value="MAP">
                    <input type="checkbox" id="context-map" name="in_context_options" value="MAP" />
                    <label for="context-map">Map</label>
                  </div>
                  <div class="context-option-item" data-value="GD">
                    <input type="checkbox" id="context-gd" name="in_context_options" value="GD" />
                    <label for="context-gd">Guest Difficulty</label>
                  </div>
                  <div class="context-option-item" data-value="NO_HS">
                    <input type="checkbox" id="context-no_hs" name="in_context_options" value="NO_HS" />
                    <label for="context-no_hs">No Hitsound</label>
                  </div>
                </div>
            </div>
            <!-- End: In-Context Options Box -->
          </fieldset>
          <fieldset>
            <legend>Basic Settings</legend>
            <label for="model">Model:</label>
            <select id="model" name="model" class="styled-select">
              <option value="v28">Mapperatorinator V28</option>
              <option value="v29" selected>Mapperatorinator V29</option>
              <option value="v30">Mapperatorinator V30</option>
            </select>
            <label for="gamemode">Gamemode:</label>
            <select id="gamemode" name="gamemode" class="styled-select">
              <option value="0">Standard</option>
              <option value="1">Taiko</option>
              <option value="2">Catch the Beat</option>
              <option value="3">Mania</option>
            </select>
            <div class="form-group" id="group-year">
                <label for="year" title="Year of the song (2007-2023)">Year (2007-2023):</label>
                <input type="number" id="year" name="year" min="2007" max="2023" value="2023" />
            </div>
            <label for="difficulty" title="Difficulty rating (star rating)">Difficulty (star rating):</label>
            <input type="number" step="0.1" id="difficulty" name="difficulty" min="0" value="5" />
            <label for="slider_multiplier" title="Slider velocity multiplier">Slider Multiplier:<span style="color:var(--accent-color); margin-left: 3px;">*</span></label>
            <input type="number" step="0.1" id="slider_multiplier" name="slider_multiplier" min="0" value="1.4" required />
            <div class="form-group" id="group-circle_size" style="display: none;">
              <label for="circle_size" title="Circle size for standard">Circle Size:<span class="required-indicator cs-required" style="color:var(--accent-color); margin-left: 3px; display: none;">*</span></label>
              <input type="number" step="0.1" id="circle_size" name="circle_size" min="0" value="4" />
            </div>
            <div class="form-group" id="group-keycount" style="display: none;">
              <label for="keycount" title="Number of keys for mania">Key Count:<span class="required-indicator kc-required" style="color:var(--accent-color); margin-left: 3px; display: none;">*</span></label>
              <input type="number" id="keycount" name="keycount" min="0" value="4" />
            </div>
          </fieldset>
          <fieldset>
            <legend>Optional Settings</legend>
            <label for="mapper_id" title="Mapper user ID for style">Mapper ID:</label>
            <input type="text" id="mapper_id" name="mapper_id" />
            <div class="form-group" id="group-hold_note_ratio" style="display: none;">
              <label for="hold_note_ratio" title="Hold note ratio for mania 0-1">Hold Note Ratio:</label>
              <input type="number" step="0.01" id="hold_note_ratio" name="hold_note_ratio" min="0" max="1" />
            </div>
            <div class="form-group" id="group-scroll_speed_ratio" style="display: none;">
              <label for="scroll_speed_ratio" title="Scroll speed ratio for mania and ctb 0-1">Scroll Speed Ratio:</label>
              <input type="number" step="0.01" id="scroll_speed_ratio" name="scroll_speed_ratio" min="0" max="1" />
            </div>
            <label for="cfg_scale" title="Scale of the classifier-free guidance">CFG Scale:</label>
            <input type="number" step="0.1" id="cfg_scale" name="cfg_scale" min="0" value="1.0"/>
            <label for="temperature">Temperature:</label>
            <input type="number" id="temperature" name="temperature" step="0.01" min="0" max="1" value="1.0">
            <label for="top_p">Top-p:</label>
            <input type="number" id="top_p" name="top_p" step="0.01" min="0" max="1" value="0.95">
            <label for="seed" title="Random seed for generation">Random Seed:</label>
            <input type="text" id="seed" name="seed" />
          </fieldset>
          <fieldset>
            <legend>Timing & Segments</legend>
            <label for="start_time" title="Generation start time in milliseconds">Start Time (ms):</label>
            <input type="number" id="start_time" name="start_time" min="0" />
            <label for="end_time" title="Generation end time in milliseconds">End Time (ms):</label>
            <input type="number" id="end_time" name="end_time" min="0" />
          </fieldset>
          <fieldset>
            <legend>Options</legend>
            <div class="option-item" id="option-item-hitsounded">
              <input type="checkbox" id="hitsounded" name="hitsounded" value="true" checked />
              <label for="hitsounded">Add Hitsounds</label>
            </div>
            <div class="option-item" id="add-to-beatmap-option" style="display: none;">
              <input type="checkbox" id="add_to_beatmap" name="add_to_beatmap" value="true" />
              <label for="add_to_beatmap" title="Whether to add generated content to the reference beatmap instead of making a new beatmap">Add to Beatmap</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="super_timing" name="super_timing" value="true" checked />
              <label for="super_timing" title="Whether to use slow accurate variable BPM timing generator">Super Timing</label>
            </div>
          </fieldset>
          <div class="custom-dropdown-descriptors">
            <div class="dropdown-header">
              <div>
                <span class="dropdown-title" title="List of descriptors for style (1 click = include, 2 clicks = exclude)">Descriptors</span>
              </div>
              <span class="dropdown-arrow">&#9660;</span>
            </div>
            <div class="dropdown-content">
              <div class="descriptors-container">
                {% set descriptor_groups = [
                    { "title": "General", "items": [
                        { "value": "gimmick", "title": "Focused on a single unique design or gameplay idea." },
                        { "value": "2B", "title": "Includes gameplay elements with two or more objects placed simultaneously." },
                        { "value": "slider only", "title": "Restricts object choice to sliders only." },
                        { "value": "circle only", "title": "Restricts object choice to circles only." },
                        { "value": "swing", "title": "Uses 1/3, 1/6, and 1/12 snap divisors for most/all objects." }
                    ]},
                    { "title": "Meta Information", "items": [
                        { "value": "collab", "title": "A map with two or more associated mappers." },
                        { "value": "megacollab", "title": "A map with 8 or more associated mappers." },
                        { "value": "marathon", "title": "A map with a drain time of over 5 minutes." },
                        { "value": "gungathon", "title": "A map with a drain time of over 10 minutes." },
                        { "value": "multi-song", "title": "Contains multiple songs within the audio." },
                        { "value": "variable timing", "title": "Contains multiple timing points, usually for non-metronome songs." },
                        { "value": "accelerating bpm", "title": "Features progressively increasing tempo." },
                        { "value": "time signatures", "title": "Many changes or uncommon time signatures." },
                        { "value": "storyboard", "title": "Contains a storyboard that enhances gameplay experience." },
                        { "value": "storyboard gimmick", "title": "Uses storyboard elements that change how the map is played." },
                        { "value": "keysounds", "title": "Uses various pitched hitsounds to create a melody." },
                        { "value": "download unavailable", "title": "Cannot be downloaded from the osu! website." },
                        { "value": "custom skin", "title": "Utilizes custom skin elements and graphics." },
                        { "value": "featured artist", "title": "Features song(s) from osu!'s Featured Artist listing." },
                        { "value": "custom song", "title": "Maps a song made specifically for the map." }
                    ]},
                    { "title": "Style", "items": [
                        { "value": "messy", "title": "Visually chaotic and disorganised patterns." },
                        { "value": "geometric", "title": "Incorporates geometric shapes within the design." },
                        { "value": "grid snap", "title": "Objects are placed along a square grid." },
                        { "value": "hexgrid", "title": "Objects are placed along a hexagonal grid." },
                        { "value": "freeform", "title": "A loose approach to visual structure." },
                        { "value": "symmetrical", "title": "Employs symmetry within the design." },
                        { "value": "old-style revival", "title": "Emulates a style from early mapping." },
                        { "value": "clean", "title": "Visually uncluttered and organised patterns." },
                        { "value": "slidershapes", "title": "Uses a variety of slider designs." },
                        { "value": "distance snapped", "title": "Uses osu's built-in distance snap feature." },
                        { "value": "iNiS-style", "title": "Originates from the original DS games." },
                        { "value": "avant-garde", "title": "Experimental design philosophies." },
                        { "value": "perfect stacks", "title": "Features perfectly overlapped stacked notes." },
                        { "value": "ninja spinners", "title": "Features very short spinners." }
                    ]},
                    { "title": "Song Representation", "items": [
                        { "value": "simple", "title": "Accessible and straightforward design." },
                        { "value": "chaotic", "title": "Unpredictable map design." },
                        { "value": "repetition", "title": "Features recognizable identical patterns." },
                        { "value": "progression", "title": "Gradual advancement in difficulty." },
                        { "value": "high contrast", "title": "Uses flashy ideas to follow music changes." },
                        { "value": "improvisation", "title": "Uses patterns that do not directly match the music." },
                        { "value": "playfield usage", "title": "Deliberate use of the playfield." },
                        { "value": "playfield constraint", "title": "Restricts object placement to a part of the playfield." },
                        { "value": "video gimmick", "title": "References the background video in its patterning." },
                        { "value": "difficulty spike", "title": "A sudden, significant challenge increase." },
                        { "value": "low sv", "title": "Prominent low slider velocity usage." },
                        { "value": "high sv", "title": "Prominent high slider velocity usage." },
                        { "value": "colorhax", "title": "Intentional use of combo colors for immersion." }
                    ]},
                    { "title": "Skillsets", "items": [
                        { "value": "tech", "title": "Tests uncommon skills." },
                        { "value": "slider tech", "title": "Tests skills involving complex sliders." },
                        { "value": "complex sv", "title": "Large changes in slider velocity to test reading." },
                        { "value": "reading", "title": "Tests a player's reading skill." },
                        { "value": "visually dense", "title": "Patterns with many visible notes that make reading hard." },
                        { "value": "overlap reading", "title": "Overlapped objects obscure note order." }
                    ]},
                    { "title": "Aim", "items": [
                        { "value": "jump aim", "title": "Focuses heavily on jumps." },
                        { "value": "sharp aim", "title": "Heavy use of sharp angle movement." },
                        { "value": "wide aim", "title": "Uses wide angle movement patterns." },
                        { "value": "linear aim", "title": "Requires continuous straight movement." },
                        { "value": "aim control", "title": "Features abrupt velocity or direction changes." },
                        { "value": "flow aim", "title": "Encourages fully continuous cursor movement." },
                        { "value": "precision", "title": "Requires fine, precise cursor movement." }
                    ]},
                    { "title": "Tap", "items": [
                        { "value": "finger control", "title": "Tests complex tapping ability." },
                        { "value": "complex snap divisors", "title": "Uses unusual snap divisors." },
                        { "value": "bursts", "title": "Continuous alternating patterns, typically 9 notes or less." },
                        { "value": "streams", "title": "Continuous alternating patterns, typically more than 9 notes." },
                        { "value": "spaced streams", "title": "Streams with large spacing between notes." },
                        { "value": "cutstreams", "title": "Streams with very uneven spacing." },
                        { "value": "stamina", "title": "Tests endurance over long periods." }
                    ]},
                    { "title": "Scene", "items": [
                        { "value": "aspire", "title": "Uses glitches for unique effects." },
                        { "value": "mapping contest", "title": "An entry for a mapping contest." },
                        { "value": "tournament custom", "title": "A custom map for a tournament." },
                        { "value": "tag", "title": "Designed for multiplayer tag mode." },
                        { "value": "port", "title": "Originally created for other media then imported." }
                    ]}
                ] %}

                {% for group in descriptor_groups %}
                  <div class="descriptor-group">
                    <h3>{{ group.title }}</h3>
                    {% for item in group["items"] %}
                      <div class="descriptor-item">
                        {% set item_id = "desc-" ~ item.value|replace(" ", "-") %}
                        <input type="checkbox" id="{{ item_id }}" name="descriptors" value="{{ item.value }}" />
                        <label for="{{ item_id }}" title="{{ item.title }}">{{ item.value }}</label>
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          <button type="submit">Run Inference</button>
        </form>
        <div id="progress_output" class="card" style="margin-top:20px; display:none;">
          <h3>Progress</h3>
          <div id="init_message">Initializing process... This may take a moment.</div>
           <div id="progressTitle" style="font-weight:bold; padding-bottom:5px;"></div>
          <div id="progressBarContainer">
            <div id="progressBar"></div>
          </div>
          <!-- Add Cancel Button (initially hidden) -->
          <div style="margin-top: 10px; text-align: center;">
            <button type="button" id="cancel-button" class="cancel-button" style="display:none;">Cancel</button>
          </div>
          <div id="beatmapLink" style="display:none; margin-top:10px;">
            <a id="beatmapLinkAnchor" href="#" target="_blank">Click Here to go to the created beatmap...</a>
          </div>
          <div id="errorLogLink" style="display:none; margin-top:10px;">
            <a id="errorLogLinkAnchor" href="#">See why... (opens error log)</a>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
      $(document).ready(function() {
        // Toggle custom dropdown for descriptors on header click
        $('.custom-dropdown-descriptors .dropdown-header').on('click', function() {
          var $dropdown = $(this).parent();
          $dropdown.toggleClass('open');
          // If the dropdown was just opened, scroll its header to the top
          if ($dropdown.hasClass('open')) {
            $('html, body').animate({
              scrollTop: $(this).offset().top
            }, 500); // 500ms smooth scroll duration
          }
        });

        $('.select2').select2({
          placeholder: "Select options",
          allowClear: true,
          dropdownCssClass: "select2-dropdown-dark",
          containerCssClass: "select2-container-dark"
        });
        // Ensure progress title div exists (idempotent)
        if (!$("#progressTitle").length) {
          $("#progress_output h3").after("<div id='progressTitle' style='font-weight:bold; padding-bottom:5px;'></div>");
        }
        // --- Browse Button Logic ---
        window.addEventListener('pywebviewready', function() {
          console.log("pywebview API is ready.");
          $("#browse-audio").click(async function() {
            try {
              const filePath = await window.pywebview.api.browse_file();
              if (filePath) {
                $("#audio_path").val(filePath);
                console.log("Selected audio file:", filePath);
              } else {
                console.log("Audio file selection cancelled.");
              }
            } catch (error) {
              console.error("Error browsing for audio file:", error);
              alert("Could not browse for file. Ensure the backend API is running.");
            }
          });
          $("#browse-output").click(async function() {
            try {
              const folderPath = await window.pywebview.api.browse_folder();
              if (folderPath) {
                $("#output_path").val(folderPath);
                 console.log("Selected output folder:", folderPath);
              } else {
                console.log("Output folder selection cancelled.");
              }
            } catch (error) {
               console.error("Error browsing for output folder:", error);
              alert("Could not browse for folder. Ensure the backend API is running.");
            }
          });
          $("#browse-beatmap").click(async function() {
            try {
              const filePath = await window.pywebview.api.browse_file();
              if (filePath) {
                $("#beatmap_path").val(filePath);
                console.log("Selected beatmap file:", filePath);
                $("#beatmap_path").trigger('input');
              } else {
                console.log("Beatmap file selection cancelled.");
              }
            } catch (error) {
              console.error("Error browsing for beatmap file:", error);
              alert("Could not browse for file. Ensure the backend API is running.");
            }
          });
        });
        // --- End Browse Button Logic ---

        // --- In-Context Dropdown Logic ---
        const $beatmapPathInput = $('#beatmap_path');
        const $inContextOptionsBox = $('#in-context-options-box');
        const $allContextCheckboxes = $inContextOptionsBox.find('input[name="in_context_options"]'); // Renamed to $allContextCheckboxes for clarity
        const $noneCheckbox = $('#context-none');
        const inContextAnimationSpeed = 300; // Used 'animationSpeed' elsewhere, renamed for local consistency
        const $addToBeatmapOption = $('#add-to-beatmap-option');

        $beatmapPathInput.on('input', function() {
          if ($(this).val().trim() !== '') {
            if (!$inContextOptionsBox.is(':visible')) {
              $inContextOptionsBox.fadeIn(inContextAnimationSpeed);
            }
            if (!$addToBeatmapOption.is(':visible')) {
              $addToBeatmapOption.slideDown(inContextAnimationSpeed);
            }
          } else {
            if ($inContextOptionsBox.is(':visible')) {
              $inContextOptionsBox.fadeOut(inContextAnimationSpeed);
            }
            if ($addToBeatmapOption.is(':visible')) {
              $addToBeatmapOption.slideUp(inContextAnimationSpeed);
              $('#add_to_beatmap').prop('checked', false);
            }
          }
        });

        // Store if a context option item is allowed by the current model
        $allContextCheckboxes.each(function() {
            $(this).closest('.context-option-item').data('model-allowed', true); // Default to true
        });

        $allContextCheckboxes.on('change', function() {
            const $changedCheckbox = $(this);
            const isNoneChecked = $noneCheckbox.is(':checked');
            // Filter for other checkboxes that are model-allowed
            const $otherCheckboxes = $allContextCheckboxes.not($noneCheckbox).filter(function() {
                return $(this).closest('.context-option-item').data('model-allowed') === true;
            });
            const $otherChecked = $otherCheckboxes.filter(':checked');

            $allContextCheckboxes.prop('disabled', true); // Disable all temporarily

            if ($changedCheckbox.is($noneCheckbox)) {
                if (isNoneChecked) { // 'None' was just checked
                    $otherCheckboxes.prop('checked', false);
                    $otherCheckboxes.closest('.context-option-item').slideUp(inContextAnimationSpeed, function() {
                        $noneCheckbox.prop('disabled', false); // Re-enable only 'None'
                        // And other model-allowed ones that were hidden by this action
                        $otherCheckboxes.each(function() {
                           if ($(this).closest('.context-option-item').data('model-allowed') === true) {
                               $(this).prop('disabled', true); // Keep them disabled as 'None' is active
                           }
                        });
                    });
                } else { // 'None' was just unchecked
                    $otherCheckboxes.each(function() {
                        const $item = $(this).closest('.context-option-item');
                        if ($item.data('model-allowed') === true) { // Only slide down if model-allowed
                            $item.slideDown(inContextAnimationSpeed);
                        }
                    });
                    // Enable all model-allowed checkboxes after animation
                    setTimeout(function() {
                        $allContextCheckboxes.each(function() {
                            if ($(this).closest('.context-option-item').data('model-allowed') === true) {
                                $(this).prop('disabled', false);
                            }
                        });
                    }, inContextAnimationSpeed);
                }
            } else { // Another checkbox was changed
                if ($changedCheckbox.is(':checked')) {
                    $noneCheckbox.prop('checked', false).prop('disabled', true); // Disable 'None'
                    if ($noneCheckbox.closest('.context-option-item').data('model-allowed') === true) {
                         $noneCheckbox.closest('.context-option-item').fadeOut(inContextAnimationSpeed);
                    }
                    // Enable others after animation if they are model-allowed
                     setTimeout(function() {
                        $otherCheckboxes.not($changedCheckbox).each(function(){
                             if ($(this).closest('.context-option-item').data('model-allowed') === true) {
                                $(this).prop('disabled', false);
                            }
                        });
                        $changedCheckbox.prop('disabled', false); // Ensure changed one is enabled
                    }, inContextAnimationSpeed);

                } else { // Another checkbox was unchecked
                    if ($otherChecked.length === 0) { // If no others are checked
                        const $noneItem = $noneCheckbox.closest('.context-option-item');
                        if ($noneItem.data('model-allowed') === true) { // Only show 'None' if model-allowed
                            $noneItem.fadeIn(inContextAnimationSpeed, function() {
                                $allContextCheckboxes.each(function() { // Re-enable all model-allowed
                                     if ($(this).closest('.context-option-item').data('model-allowed') === true) {
                                        $(this).prop('disabled', false);
                                    }
                                });
                            });
                            $noneCheckbox.prop('disabled', false);
                        } else { // 'None' is not model-allowed, so just re-enable others
                             setTimeout(function() {
                                $allContextCheckboxes.each(function() {
                                     if ($(this).closest('.context-option-item').data('model-allowed') === true) {
                                        $(this).prop('disabled', false);
                                    }
                                });
                            }, inContextAnimationSpeed);
                        }
                    } else { // Others are still checked
                        setTimeout(function() {
                            $allContextCheckboxes.each(function() {
                                 if ($(this).closest('.context-option-item').data('model-allowed') === true) {
                                    $(this).prop('disabled', false);
                                }
                            });
                        }, inContextAnimationSpeed);
                    }
                }
            }
        });
        // Initial state for In-Context (run once if beatmap path might be pre-filled)
        function initializeInContextVisibility() {
            const $otherModelAllowedCheckboxes = $allContextCheckboxes.not($noneCheckbox).filter(function() {
                return $(this).closest('.context-option-item').data('model-allowed') === true && $(this).is(':checked');
            });

            if ($otherModelAllowedCheckboxes.length > 0) {
                $noneCheckbox.prop('checked', false).closest('.context-option-item').hide();
            } else if ($noneCheckbox.is(':checked') && $noneCheckbox.closest('.context-option-item').data('model-allowed') === true) {
                $allContextCheckboxes.not($noneCheckbox).prop('checked', false).closest('.context-option-item').hide();
            }
            // Ensure only model-allowed are visible initially
            $allContextCheckboxes.each(function() {
                const $item = $(this).closest('.context-option-item');
                if ($item.data('model-allowed') === false) {
                    $item.hide();
                }
            });
        }
        // --- End In-Context Dropdown Logic ---

        // --- Gamemode Conditional Visibility ---
        function updateOptionalSettingsVisibility() {
          var selectedGamemode = $("#gamemode").val();
          var animationSpeed = 200;
          var $circleSizeInput = $("#circle_size");
          var $circleSizeAsterisk = $(".cs-required");
          var $keyCountInput = $("#keycount");
          var $keyCountAsterisk = $(".kc-required");

          var showCircleSize = (selectedGamemode === '0');
          var showKeyCount = (selectedGamemode === '3');
          var showHoldNoteRatio = (selectedGamemode === '3');
          var showScrollSpeed = (selectedGamemode === '2' || selectedGamemode === '3');

          if (showCircleSize) {
              if (!$("#group-circle_size").is(':visible')) $("#group-circle_size").slideDown(animationSpeed);
              $circleSizeInput.prop('required', true); $circleSizeAsterisk.show();
          } else {
              if ($("#group-circle_size").is(':visible')) $("#group-circle_size").slideUp(animationSpeed);
              $circleSizeInput.prop('required', false); $circleSizeAsterisk.hide();
          }
          if (showKeyCount) {
              if (!$("#group-keycount").is(':visible')) $("#group-keycount").slideDown(animationSpeed);
              $keyCountInput.prop('required', true); $keyCountAsterisk.show();
          } else {
              if ($("#group-keycount").is(':visible')) $("#group-keycount").slideUp(animationSpeed);
              $keyCountInput.prop('required', false); $keyCountAsterisk.hide();
          }
          if (showHoldNoteRatio && !$("#group-hold_note_ratio").is(':visible')) {
            $("#group-hold_note_ratio").slideDown(animationSpeed);
          } else if (!showHoldNoteRatio && $("#group-hold_note_ratio").is(':visible')) {
            $("#group-hold_note_ratio").slideUp(animationSpeed);
          }
          if (showScrollSpeed && !$("#group-scroll_speed_ratio").is(':visible')) {
            $("#group-scroll_speed_ratio").slideDown(animationSpeed);
          } else if (!showScrollSpeed && $("#group-scroll_speed_ratio").is(':visible')) {
            $("#group-scroll_speed_ratio").slideUp(animationSpeed);
          }
        }
        $("#gamemode").on('change', updateOptionalSettingsVisibility);
        // --- End Gamemode Conditional Visibility ---

        // --- Model Conditional Visibility and Disabling ---
        const modelFieldAnimationSpeed = 200; // Consistent animation speed
        const modelCapabilities = { // Simplified, actual capabilities checked directly in func
          "v28": {},
          "v29": {},
          "v30": {
            supportedGamemodes: ['0'],
            supportsYear: false,
            supportedInContextOptions: ['TIMING', 'NONE'], // NONE is needed to untick TIMING
            hideHitsoundsOption: true, // Custom flag for specific V30 behavior
            supportsDescriptors: false,
          },
        };

        function updateModelSettingsVisibility() {
          const selectedModel = $("#model").val();
          const capabilities = modelCapabilities[selectedModel] || {}; // Default to empty if model not in map

          // Gamemode
          const $gamemodeSelect = $("#gamemode");
          const $gamemodeOptions = $gamemodeSelect.find("option");
          if (selectedModel === "v30") {
            $gamemodeSelect.val('0').prop('disabled', true); // Force Standard and disable select
            $gamemodeOptions.each(function() {
                $(this).prop('disabled', $(this).val() !== '0');
            });
          } else { // V28, V29
            $gamemodeSelect.prop('disabled', false);
            $gamemodeOptions.prop('disabled', false);
          }
          $gamemodeSelect.trigger('change'); // Update fields dependent on gamemode

          // Year
          const $yearGroup = $("#group-year");
          const yearSupported = capabilities.supportsYear !== false; // Default to true
          if (yearSupported) {
            if (!$yearGroup.is(':visible')) $yearGroup.slideDown(modelFieldAnimationSpeed);
          } else {
            if ($yearGroup.is(':visible')) $yearGroup.slideUp(modelFieldAnimationSpeed);
            $("#year").val('2023'); // Reset to default if hidden
          }

          // In-Context Options
          const supportedContext = capabilities.supportedInContextOptions || ['NONE', 'TIMING', 'KIAI', 'MAP', 'GD', 'NO_HS']; // Default to all for V28/V29
          let isTimingCheckedForV30 = false;
          if (selectedModel === "v30") {
                isTimingCheckedForV30 = $('#context-timing').is(':checked');
          }

          $allContextCheckboxes.each(function() {
            const $checkbox = $(this);
            const value = $checkbox.val();
            const $item = $checkbox.closest('.context-option-item');
            if (supportedContext.includes(value)) {
              $item.data('model-allowed', true);
              if (!$item.is(':visible')) $item.slideDown(modelFieldAnimationSpeed);
              $checkbox.prop('disabled', false); // Enable, specific logic below for V30 None/Timing
            } else {
              $item.data('model-allowed', false);
              if ($item.is(':visible')) $item.slideUp(modelFieldAnimationSpeed);
              $checkbox.prop('checked', false).prop('disabled', true);
            }
          });

          // Special In-Context logic for V30 (Timing and None interaction)
          if (selectedModel === "v30") {
            const $timingCheckboxV30 = $('#context-timing');
            const $noneCheckboxV30 = $('#context-none');
             // If TIMING was checked, keep it. Else, ensure NONE is checked.
            if (isTimingCheckedForV30) {
                $timingCheckboxV30.prop('checked', true);
                $noneCheckboxV30.prop('checked', false).prop('disabled', true);
                $noneCheckboxV30.closest('.context-option-item').hide();
            } else {
                $timingCheckboxV30.prop('checked', false);
                $noneCheckboxV30.prop('checked', true).prop('disabled', false);
                $noneCheckboxV30.closest('.context-option-item').show();
            }
            $timingCheckboxV30.prop('disabled', false); // Timing always toggleable for V30
          } else {
            // For V28/V29, re-evaluate "None" based on others after model change
            const $otherVisibleAllowedAndChecked = $allContextCheckboxes.not($noneCheckbox).filter(function() {
                return $(this).closest('.context-option-item').data('model-allowed') === true && $(this).is(':checked');
            });
            if ($otherVisibleAllowedAndChecked.length > 0) {
                $noneCheckbox.prop('checked', false).prop('disabled', true);
                $noneCheckbox.closest('.context-option-item').hide();
            } else {
                 $noneCheckbox.prop('checked', true).prop('disabled', false);
                 // Only show if it's generally model-allowed (which it is for V28/V29)
                 if ($noneCheckbox.closest('.context-option-item').data('model-allowed') === true) {
                    $noneCheckbox.closest('.context-option-item').show();
                 }
            }
          }
           // Trigger a change on a context checkbox to re-evaluate display logic if box is visible
           if ($inContextOptionsBox.is(':visible') && $allContextCheckboxes.filter(':visible').length > 0) {
                $allContextCheckboxes.filter(':visible').first().trigger('change'); // This can be risky if it causes loops.
                                                                                // Better: call a consolidated update function.
                                                                                // For now, we hope the direct state setting above is enough.
           }


          // Add Hitsounds
          const $hitsoundedOptionItem = $("#option-item-hitsounded");
          const $hitsoundedCheckbox = $("#hitsounded");
          if (capabilities.hideHitsoundsOption === true) { // V30: hide and set to true
            if ($hitsoundedOptionItem.is(':visible')) $hitsoundedOptionItem.slideUp(modelFieldAnimationSpeed);
            $hitsoundedCheckbox.prop('checked', true); // Implicitly true for V30
          } else { // V28, V29: user can choose
            if (!$hitsoundedOptionItem.is(':visible')) $hitsoundedOptionItem.slideDown(modelFieldAnimationSpeed);
            $hitsoundedCheckbox.prop('disabled', false);
            // Do not change checked state, respect user's previous choice or default
          }

          // Descriptors
          const $descriptorsDropdown = $(".custom-dropdown-descriptors");
          const descriptorsSupported = capabilities.supportsDescriptors !== false; // Default to true
          if (descriptorsSupported) {
            if (!$descriptorsDropdown.is(':visible')) $descriptorsDropdown.slideDown(modelFieldAnimationSpeed);
            $descriptorsDropdown.find('input[name="descriptors"]').prop('disabled', false);
          } else {
            if ($descriptorsDropdown.is(':visible')) {
                $descriptorsDropdown.slideUp(modelFieldAnimationSpeed);
                if ($descriptorsDropdown.hasClass('open')) $descriptorsDropdown.removeClass('open');
            }
            $descriptorsDropdown.find('input[name="descriptors"]').each(function() {
              $(this).removeClass('positive-check negative-check').prop('checked', false).prop('disabled', true);
            });
          }
          initializeInContextVisibility(); // Re-check in-context visibility after model changes
        }
        // --- End Model Conditional Visibility ---

        // Initial calls on page load
        updateOptionalSettingsVisibility(); // For gamemode
        updateModelSettingsVisibility();    // For model (which also calls updateOptionalSettingsVisibility)

        $("#model").on('change', updateModelSettingsVisibility);

        // --- Descriptor Checkbox 3-State Logic ---
        function handleDescriptorClick(e) {
            var $checkbox = $(this);
            e.preventDefault();
            if (!$checkbox.prop('disabled')) {
                 if ($checkbox.hasClass('positive-check')) {
                    $checkbox.removeClass('positive-check').addClass('negative-check');
                    $checkbox.prop('checked', true);
                     console.log($checkbox.val() + ' set to negative');
                 } else if ($checkbox.hasClass('negative-check')) {
                    $checkbox.removeClass('negative-check');
                    $checkbox.prop('checked', false);
                     console.log($checkbox.val() + ' set to off');
                 } else {
                   $checkbox.addClass('positive-check');
                   $checkbox.prop('checked', true);
                    console.log($checkbox.val() + ' set to positive');
                 }
            }
        }
         if (!$('.custom-dropdown-descriptors').data('descriptor-click-attached')) {
               $('.descriptors-container').on('click', 'input[name="descriptors"]', handleDescriptorClick);
               $('.custom-dropdown-descriptors').data('descriptor-click-attached', true);
         }
        // --- End Descriptor Checkbox Logic ---

        // --- Form Submission & Progress Handling ---
        var evtSource = null;
        var isCancelled = false;
        let inferenceErrorOccurred = false;
        let accumulatedErrorMessages = [];
        let errorLogFilePath = null;

        function showFlashMessage(message, type = 'success') {
            const flashContainer = $('#flash-container');
            let alertClass = 'alert ';
            if (type === 'success') alertClass += 'success';
            else if (type === 'error') alertClass += 'error';
            else if (type === 'cancel-success') alertClass += 'alert-cancel-success';
            else alertClass += 'success';
            const messageDiv = $('<div class="' + alertClass + '">' + message + '</div>');
            flashContainer.append(messageDiv);
            setTimeout(() => { messageDiv.remove(); }, 5000);
        }

        $("#inferenceForm").submit(function(e) {
          const audioPath = $('#audio_path').val().trim();
          const beatmapPath = $('#beatmap_path').val().trim();
          if (!audioPath && !beatmapPath) {
              e.preventDefault();
              $('html, body').animate({ scrollTop: 0 }, 500);
              showFlashMessage("Either 'Beatmap Path' or 'Audio Path' are required for running inference", 'error');
              return;
          }
          e.preventDefault();
          $('#flash-container').empty();
          $("#progress_output .cancellation-message").remove();
          $("#progress_output").show();
          $('html, body').animate({ scrollTop: $('#progress_output').offset().top }, 500);
          $("#progressBarContainer").show();
          $("#progressTitle").show();
          $("#progressBar").css("width", "0%").removeClass('cancelled error');
          $("#beatmapLink").hide();
          $("#errorLogLink").hide();
          $("#init_message").text("Initializing process... This may take a moment.").show();
          $("#progressTitle").text("");
          $("#cancel-button").hide().prop('disabled', false).text('Cancel');
          var $submitButton = $("button[type='submit']");
          var $cancelButton = $("#cancel-button");
          $submitButton.prop("disabled", true);
          inferenceErrorOccurred = false;
          accumulatedErrorMessages = [];
          $("#progressTitle").css('color', '');
          if (evtSource) { evtSource.close(); evtSource = null; }

          $.ajax({
            url: "/start_inference",
            method: "POST",
            data: function() {
                var formData = new FormData($("#inferenceForm")[0]);
                formData.delete('descriptors'); // Clear existing
                var positiveDescriptors = [];
                var negativeDescriptors = [];
                $('input[name="descriptors"]').each(function() {
                    var $cb = $(this);
                    if ($cb.hasClass('positive-check')) positiveDescriptors.push($cb.val());
                    else if ($cb.hasClass('negative-check')) negativeDescriptors.push($cb.val());
                });
                positiveDescriptors.forEach(val => formData.append('descriptors', val));
                negativeDescriptors.forEach(val => formData.append('negative_descriptors', val));
                // Ensure 'hitsounded' for V30 is true if its checkbox is hidden
                if ($("#model").val() === "v30" && !$("#option-item-hitsounded").is(':visible')) {
                    if (!formData.has('hitsounded')) { // Add if not present (e.g. checkbox was hidden)
                        formData.append('hitsounded', 'true');
                    } else { // Ensure it's true if present
                         formData.set('hitsounded', 'true');
                    }
                }
                return formData;
            }(),
            processData: false,
            contentType: false,
            success: function() {
              $cancelButton.show();
              console.log("Inference started. Connecting to SSE stream...");
              evtSource = new EventSource("/stream_output");
              errorLogFilePath = null;
              evtSource.onmessage = function(e) {
                if ($("#init_message").is(":visible")) $("#init_message").hide();
                if (isCancelled) return;
                console.log("SSE Data:", e.data);
                const messageData = e.data;
                const errorIndicators = ["Traceback (most recent call last):", "Error executing job with overrides:", "FileNotFoundError:", "Exception:", "Set the environment variable HYDRA_FULL_ERROR=1"];
                let isErrorMessage = errorIndicators.some(indicator => messageData.includes(indicator));

                if (isErrorMessage && !inferenceErrorOccurred) {
                    console.warn("Error detected in SSE stream.");
                    inferenceErrorOccurred = true;
                    accumulatedErrorMessages.push(messageData);
                    $("#progressTitle").text("Error Detected").css('color', 'var(--accent-color)');
                    $("#progressBar").addClass('error');
                } else if (inferenceErrorOccurred) {
                    accumulatedErrorMessages.push(messageData);
                } else {
                    const lowerCaseMessage = messageData.toLowerCase();
                    let newTitle = null;
                    if (lowerCaseMessage.includes("generating timing")) newTitle = "Generating Timing";
                    else if (lowerCaseMessage.includes("generating kiai")) newTitle = "Generating Kiai";
                    else if (lowerCaseMessage.includes("generating map")) newTitle = "Generating Map";
                    else if (lowerCaseMessage.includes("seq len")) newTitle = "Refining Positions";
                    if (newTitle) $("#progressTitle").text(newTitle);

                    var progressMatch = messageData.match(/^\s*(\d+)%\|/);
                    if (progressMatch) {
                      var currentPercent = parseInt(progressMatch[1].trim(), 10);
                      if (!isNaN(currentPercent)) $("#progressBar").css("width", currentPercent + "%");
                    } else if (messageData.includes("Generated beatmap saved to")) {
                      var beatmapLine = messageData.trim();
                      var parts = beatmapLine.split("Generated beatmap saved to");
                      if (parts.length > 1) {
                        var fullPath = parts[1].trim().replace(/\\/g, "/");
                        var folderPath = fullPath.substring(0, fullPath.lastIndexOf("/"));
                        $("#beatmapLinkAnchor")
                          .attr("href", "#")
                          .text("Click here to open the folder containing your map.")
                          .off("click")
                          .on("click", function(clickEvent) {
                            clickEvent.preventDefault();
                            $.get("/open_folder", { folder: folderPath })
                              .done(response => console.log("Open folder response:", response))
                              .fail(() => alert("Failed to open folder via backend."));
                          });
                        $("#beatmapLink").show();
                      }
                    }
                }
              };
              evtSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                if (evtSource) evtSource.close(); evtSource = null;
                if (!isCancelled && !inferenceErrorOccurred) {
                   inferenceErrorOccurred = true;
                   accumulatedErrorMessages.push("Error: Connection to process stream lost.");
                   $("#progressTitle").text("Connection Error").css('color', 'var(--accent-color)');
                   $("#progressBar").addClass('error');
                   showFlashMessage("Error: Connection to process stream lost.", "error");
                }
                if (!isCancelled) $submitButton.prop("disabled", false);
                $cancelButton.hide();
              };
              evtSource.addEventListener("error_log", function(e) {
                  errorLogFilePath = e.data;
              });
              evtSource.addEventListener("end", function(e) {
                console.log("Received end event from server.", e.data);
                if (evtSource) evtSource.close(); evtSource = null;
                if (isCancelled) {
                    console.log("SSE End event received after cancellation.");
                     $("#progressTitle").hide(); $("#progressBarContainer").hide();
                     $("#beatmapLink").hide(); $("#errorLogLink").hide();
                } else if (inferenceErrorOccurred) {
                    console.error("Process finished with errors.");
                    let specificError = "An error occurred during processing. Check console/logs.";
                    const fullErrorText = accumulatedErrorMessages.join("\\n");
                    if (fullErrorText.includes("FileNotFoundError:")) {
                         const fileNotFoundMatch = fullErrorText.match(/FileNotFoundError:.*? file (.*?) not found/);
                         specificError = fileNotFoundMatch && fileNotFoundMatch[1] ? `Error: File not found - ${fileNotFoundMatch[1].replace(/\\\\/g, '\\\\')}` : "Error: A required file was not found.";
                    } else if (fullErrorText.includes("HYDRA_FULL_ERROR=1")) {
                        specificError = "There was an error while creating the beatmap. Check console/logs for details.";
                    } else if (fullErrorText.includes("Error executing job")) {
                         specificError = "There was an error starting or executing the generation task.";
                    } else if (fullErrorText.includes("Connection to process stream lost")) {
                        specificError = "Error: Connection to the generation process was lost.";
                    }
                    showFlashMessage(specificError, "error");
                    $("#progressTitle").text("Processing Failed").css('color', 'var(--accent-color)').show();
                    $("#progressBar").css("width", "100%").addClass('error');
                    $("#progressBarContainer").show();
                    $("#beatmapLink").hide();
                    if (errorLogFilePath) {
                        $("#errorLogLinkAnchor")
                            .off("click")
                            .on("click", function(clickEvent) {
                                clickEvent.preventDefault();
                                $.get("/open_log_file", { path: errorLogFilePath })
                                    .done(response => console.log("Open log response:", response))
                                    .fail(() => alert("Failed to open log file via backend."));
                            });
                        $("#errorLogLink").show();
                    }
                } else {
                     $("#progressTitle").show().text("Processing Complete").css('color', '');
                     $("#progressBarContainer").show();
                     $("#progressBar").css("width", "100%").removeClass('error');
                }
                $submitButton.prop("disabled", false);
                $cancelButton.hide();
                isCancelled = false;
                inferenceErrorOccurred = false;
                accumulatedErrorMessages = [];
              });
            },
            error: function(jqXHR, textStatus, errorThrown) {
              console.error("Failed to start inference:", textStatus, errorThrown);
              alert("Failed to start inference process. Check backend console.");
              $submitButton.prop("disabled", false);
              $cancelButton.hide();
              $("#progress_output").hide();
            }
          });
        });
        $("#cancel-button").click(function() {
            var $cancelBtn = $(this);
            $cancelBtn.prop('disabled', true).text('Cancelling...');
            $.ajax({
                url: "/cancel_inference",
                method: "POST",
                success: function(response) {
                    isCancelled = true;
                    $("#progress_output").hide();
                    showFlashMessage("Inference cancelled successfully.", "cancel-success");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : "Failed to send cancel request. Unknown error.";
                    showFlashMessage(errorMsg, "error");
                    $cancelBtn.prop('disabled', false).text('Cancel');
                }
            });
        });
      });
    </script>
  </body>
</html>