<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapperatorinator Interface (Flask+pywebview)</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <!-- Container for Flash Messages/Popups -->
    <div id="flash-container"></div>

    <div class="container">
      <main>
        <form id="inferenceForm" method="POST" class="card form-card"> <fieldset>
            <legend>Paths</legend>
            <div class="path-input-group"> <label for="audio_path">Audio Path:</label>
              <input type="text" id="audio_path" name="audio_path" />
              <button type="button" id="browse-audio" class="browse-button">Browse...</button>
            </div>
            <div class="path-input-group"> <label for="output_path">Output Path:</label>
              <input type="text" id="output_path" name="output_path" />
              <button type="button" id="browse-output" class="browse-button">Browse...</button>
            </div>
            <div class="path-input-group"> <label for="beatmap_path" title="Path to .osu file to autofill metadata, audio path, and output path, or use as reference">Beatmap Path:</label>
              <input type="text" id="beatmap_path" name="beatmap_path" />
              <button type="button" id="browse-beatmap" class="browse-button">Browse...</button>
            </div>
            <!-- Start: In-Context Options Box -->
            <div id="in-context-options-box" class="context-options-box" style="display: none;">
                <h4 title="List of additional context to provide to the model">In-Context Options</h4> <!-- Title inside the box -->
                <div class="context-options-container">
                  <div class="context-option-item" data-value="NONE">
                    <input type="checkbox" id="context-none" name="in_context_options" value="NONE" />
                    <label for="context-none">None</label>
                  </div>
                  <div class="context-option-item" data-value="TIMING">
                    <input type="checkbox" id="context-timing" name="in_context_options" value="TIMING" />
                    <label for="context-timing">Timing</label>
                  </div>
                  <div class="context-option-item" data-value="KIAI">
                    <input type="checkbox" id="context-kiai" name="in_context_options" value="KIAI" />
                    <label for="context-kiai">Kiai</label>
                  </div>
                  <div class="context-option-item" data-value="MAP">
                    <input type="checkbox" id="context-map" name="in_context_options" value="MAP" />
                    <label for="context-map">Map</label>
                  </div>
                  <div class="context-option-item" data-value="GD">
                    <input type="checkbox" id="context-gd" name="in_context_options" value="GD" />
                    <label for="context-gd">Guest Difficulty</label>
                  </div>
                  <div class="context-option-item" data-value="NO_HS">
                    <input type="checkbox" id="context-no_hs" name="in_context_options" value="NO_HS" />
                    <label for="context-no_hs">No Hitsound</label>
                  </div>
                </div>
            </div>
            <!-- End: In-Context Options Box -->
          </fieldset>

          <fieldset>
            <legend>Basic Settings</legend>
            <label for="gamemode">Gamemode:</label>
            <select id="gamemode" name="gamemode" class="styled-select">
              <option value="0">Standard</option>
              <option value="1">Taiko</option>
              <option value="2">Catch the Beat</option>
              <option value="3">Mania</option>
            </select>
            <label for="year">Year (2007-2023):<span style="color:var(--accent-color); margin-left: 3px;">*</span></label>
            <input type="number" id="year" name="year" min="2007" max="2023" value="2023" required />
            <label for="difficulty">Difficulty (star rating):<span style="color:var(--accent-color); margin-left: 3px;">*</span></label>
            <input type="number" step="0.1" id="difficulty" name="difficulty" min="0" value="5" required />
            <label for="slider_multiplier" title="Slider velocity multiplier">Slider Multiplier:<span style="color:var(--accent-color); margin-left: 3px;">*</span></label>
            <input type="number" step="0.1" id="slider_multiplier" name="slider_multiplier" min="0" value="1.4" required />
            <div class="form-group" id="group-circle_size" style="display: none;">
              <label for="circle_size">Circle Size:<span class="required-indicator cs-required" style="color:var(--accent-color); margin-left: 3px; display: none;">*</span></label>
              <input type="number" step="0.1" id="circle_size" name="circle_size" min="0" value="4" />
            </div>
            <div class="form-group" id="group-keycount" style="display: none;">
              <label for="keycount">Key Count:<span class="required-indicator kc-required" style="color:var(--accent-color); margin-left: 3px; display: none;">*</span></label>
              <input type="number" id="keycount" name="keycount" min="0" value="4" />
            </div>
          </fieldset>

          <fieldset>
            <legend>Optional Settings</legend>
            <label for="mapper_id" title="Mapper user ID for style">Mapper ID:</label>
            <input type="text" id="mapper_id" name="mapper_id" />
            <div class="form-group" id="group-hold_note_ratio">
              <label for="hold_note_ratio" title="Hold note ratio for mania 0-1">Hold Note Ratio:</label>
              <input type="number" step="0.01" id="hold_note_ratio" name="hold_note_ratio" min="0" max="1" />
            </div>
            <div class="form-group" id="group-scroll_speed_ratio">
              <label for="scroll_speed_ratio" title="Scroll speed ratio for mania and ctb 0-1">Scroll Speed Ratio:</label>
              <input type="number" step="0.01" id="scroll_speed_ratio" name="scroll_speed_ratio" min="0" max="1" />
            </div>
            <label for="cfg_scale" title="Scale of the classifier-free guidance">CFG Scale:</label>
            <input type="number" step="0.1" id="cfg_scale" name="cfg_scale" min="0" />
            <label for="seed" title="Random seed for generation">Random Seed:</label>
            <input type="text" id="seed" name="seed" />
          </fieldset>

          <fieldset>
            <legend>Timing & Segments</legend>
            <label for="start_time" title="Generation start time in milliseconds">Start Time (ms):</label>
            <input type="number" id="start_time" name="start_time" min="0" />
            <label for="end_time" title="Generation end time in milliseconds">End Time (ms):</label>
            <input type="number" id="end_time" name="end_time" min="0" />
          </fieldset>

          <fieldset>
            <legend>Options</legend>
            <div class="option-item">
              <input type="checkbox" id="hitsounded" name="hitsounded" value="true" checked />
              <label for="hitsounded">Add Hitsounds</label>
            </div>
            <div class="option-item" id="add-to-beatmap-option" style="display: none;">
              <input type="checkbox" id="add_to_beatmap" name="add_to_beatmap" value="true" />
              <label for="add_to_beatmap" title="Whether to add generated content to the reference beatmap instead of making a new beatmap">Add to Beatmap</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="super_timing" name="super_timing" value="true" checked />
              <label for="super_timing" title="Whether to use slow accurate variable BPM timing generator">Super Timing</label>
            </div>
          </fieldset>

          <div class="custom-dropdown-descriptors">
            <div class="dropdown-header">
              <div>
                <span class="dropdown-title" title="List of descriptors for style (1 click = include, 2 clicks = exclude)">Descriptors</span>
              </div>
              <span class="dropdown-arrow">&#9660;</span>
            </div>
            <div class="dropdown-content">
              <div class="descriptors-container">
                {% set descriptor_groups = [
                    { "title": "General", "items": [
                        { "value": "gimmick", "title": "Focused on a single unique design or gameplay idea." },
                        { "value": "2B", "title": "Includes gameplay elements with two or more objects placed simultaneously." },
                        { "value": "slider only", "title": "Restricts object choice to sliders only." },
                        { "value": "circle only", "title": "Restricts object choice to circles only." },
                        { "value": "swing", "title": "Uses 1/3, 1/6, and 1/12 snap divisors for most/all objects." }
                    ]},
                    { "title": "Meta Information", "items": [
                        { "value": "collab", "title": "A map with two or more associated mappers." },
                        { "value": "megacollab", "title": "A map with 8 or more associated mappers." },
                        { "value": "marathon", "title": "A map with a drain time of over 5 minutes." },
                        { "value": "gungathon", "title": "A map with a drain time of over 10 minutes." },
                        { "value": "multi-song", "title": "Contains multiple songs within the audio." },
                        { "value": "variable timing", "title": "Contains multiple timing points, usually for non-metronome songs." },
                        { "value": "accelerating bpm", "title": "Features progressively increasing tempo." },
                        { "value": "time signatures", "title": "Many changes or uncommon time signatures." },
                        { "value": "storyboard", "title": "Contains a storyboard that enhances gameplay experience." },
                        { "value": "storyboard gimmick", "title": "Uses storyboard elements that change how the map is played." },
                        { "value": "keysounds", "title": "Uses various pitched hitsounds to create a melody." },
                        { "value": "download unavailable", "title": "Cannot be downloaded from the osu! website." },
                        { "value": "custom skin", "title": "Utilizes custom skin elements and graphics." },
                        { "value": "featured artist", "title": "Features song(s) from osu!'s Featured Artist listing." },
                        { "value": "custom song", "title": "Maps a song made specifically for the map." }
                    ]},
                    { "title": "Style", "items": [
                        { "value": "messy", "title": "Visually chaotic and disorganised patterns." },
                        { "value": "geometric", "title": "Incorporates geometric shapes within the design." },
                        { "value": "grid snap", "title": "Objects are placed along a square grid." },
                        { "value": "hexgrid", "title": "Objects are placed along a hexagonal grid." },
                        { "value": "freeform", "title": "A loose approach to visual structure." },
                        { "value": "symmetrical", "title": "Employs symmetry within the design." },
                        { "value": "old-style revival", "title": "Emulates a style from early mapping." },
                        { "value": "clean", "title": "Visually uncluttered and organised patterns." },
                        { "value": "slidershapes", "title": "Uses a variety of slider designs." },
                        { "value": "distance snapped", "title": "Uses osu's built-in distance snap feature." },
                        { "value": "iNiS-style", "title": "Originates from the original DS games." },
                        { "value": "avant-garde", "title": "Experimental design philosophies." },
                        { "value": "perfect stacks", "title": "Features perfectly overlapped stacked notes." },
                        { "value": "ninja spinners", "title": "Features very short spinners." }
                    ]},
                    { "title": "Song Representation", "items": [
                        { "value": "simple", "title": "Accessible and straightforward design." },
                        { "value": "chaotic", "title": "Unpredictable map design." },
                        { "value": "repetition", "title": "Features recognizable identical patterns." },
                        { "value": "progression", "title": "Gradual advancement in difficulty." },
                        { "value": "high contrast", "title": "Uses flashy ideas to follow music changes." },
                        { "value": "improvisation", "title": "Uses patterns that do not directly match the music." },
                        { "value": "playfield usage", "title": "Deliberate use of the playfield." },
                        { "value": "playfield constraint", "title": "Restricts object placement to a part of the playfield." },
                        { "value": "video gimmick", "title": "References the background video in its patterning." },
                        { "value": "difficulty spike", "title": "A sudden, significant challenge increase." },
                        { "value": "low sv", "title": "Prominent low slider velocity usage." },
                        { "value": "high sv", "title": "Prominent high slider velocity usage." },
                        { "value": "colorhax", "title": "Intentional use of combo colors for immersion." }
                    ]},
                    { "title": "Skillsets", "items": [
                        { "value": "tech", "title": "Tests uncommon skills." },
                        { "value": "slider tech", "title": "Tests skills involving complex sliders." },
                        { "value": "complex sv", "title": "Large changes in slider velocity to test reading." },
                        { "value": "reading", "title": "Tests a player's reading skill." },
                        { "value": "visually dense", "title": "Patterns with many visible notes that make reading hard." },
                        { "value": "overlap reading", "title": "Overlapped objects obscure note order." }
                    ]},
                    { "title": "Aim", "items": [
                        { "value": "jump aim", "title": "Focuses heavily on jumps." },
                        { "value": "sharp aim", "title": "Heavy use of sharp angle movement." },
                        { "value": "wide aim", "title": "Uses wide angle movement patterns." },
                        { "value": "linear aim", "title": "Requires continuous straight movement." },
                        { "value": "aim control", "title": "Features abrupt velocity or direction changes." },
                        { "value": "flow aim", "title": "Encourages fully continuous cursor movement." },
                        { "value": "precision", "title": "Requires fine, precise cursor movement." }
                    ]},
                    { "title": "Tap", "items": [
                        { "value": "finger control", "title": "Tests complex tapping ability." },
                        { "value": "complex snap divisors", "title": "Uses unusual snap divisors." },
                        { "value": "bursts", "title": "Continuous alternating patterns, typically 9 notes or less." },
                        { "value": "streams", "title": "Continuous alternating patterns, typically more than 9 notes." },
                        { "value": "spaced streams", "title": "Streams with large spacing between notes." },
                        { "value": "cutstreams", "title": "Streams with very uneven spacing." },
                        { "value": "stamina", "title": "Tests endurance over long periods." }
                    ]},
                    { "title": "Scene", "items": [
                        { "value": "aspire", "title": "Uses glitches for unique effects." },
                        { "value": "mapping contest", "title": "An entry for a mapping contest." },
                        { "value": "tournament custom", "title": "A custom map for a tournament." },
                        { "value": "tag", "title": "Designed for multiplayer tag mode." },
                        { "value": "port", "title": "Originally created for other media then imported." }
                    ]}
                ] %}
          
                {% for group in descriptor_groups %}
                  <div class="descriptor-group">
                    <h3>{{ group.title }}</h3>
                    {% for item in group["items"] %}
                      <div class="descriptor-item">
                        {% set item_id = "desc-" ~ item.value|replace(" ", "-") %}
                        <input type="checkbox" id="{{ item_id }}" name="descriptors" value="{{ item.value }}" />
                        <label for="{{ item_id }}" title="{{ item.title }}">{{ item.value }}</label>
                      </div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <button type="submit">Run Inference</button>
        </form>

        <div id="progress_output" class="card" style="margin-top:20px; display:none;">
          <h3>Progress</h3>
          <div id="init_message">Initializing process... This may take a moment.</div>
           <div id="progressTitle" style="font-weight:bold; padding-bottom:5px;"></div>
          <div id="progressBarContainer">
            <div id="progressBar"></div>
          </div>
          <!-- Add Cancel Button (initially hidden) -->
          <div style="margin-top: 10px; text-align: center;"> 
            <button type="button" id="cancel-button" class="cancel-button" style="display:none;">Cancel</button>
          </div>
          <div id="beatmapLink" style="display:none; margin-top:10px;">
            <a id="beatmapLinkAnchor" href="#" target="_blank">Click Here to go to the created beatmap...</a>
          </div>
        </div>
      </main>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <script>
      $(document).ready(function() {
        // Toggle custom dropdown for descriptors on header click
        $('.custom-dropdown-descriptors .dropdown-header').on('click', function() {
          var $dropdown = $(this).parent();
          $dropdown.toggleClass('open');

          // If the dropdown was just opened, scroll its header to the top
          if ($dropdown.hasClass('open')) {
            $('html, body').animate({
              scrollTop: $(this).offset().top
            }, 500); // 500ms smooth scroll duration
          }
        });
        
        $('.select2').select2({
          placeholder: "Select options",
          allowClear: true,
          dropdownCssClass: "select2-dropdown-dark",
          containerCssClass: "select2-container-dark"
        });

        // Ensure progress title div exists (idempotent)
        if (!$("#progressTitle").length) {
          $("#progress_output h3").after("<div id='progressTitle' style='font-weight:bold; padding-bottom:5px;'></div>");
        }

        // --- Browse Button Logic ---
        // REMOVED sanitizePath function

        // Wait for pywebview API to be ready before attaching handlers
        window.addEventListener('pywebviewready', function() {
          console.log("pywebview API is ready.");

          $("#browse-audio").click(async function() {
            try {
              // Call using window.pywebview.api
              const filePath = await window.pywebview.api.browse_file();
              // REMOVED sanitizePath call
              if (filePath) { // Check raw path
                $("#audio_path").val(filePath); // Use raw path
                console.log("Selected audio file:", filePath); // Log raw path
              } else {
                console.log("Audio file selection cancelled.");
              }
            } catch (error) {
              console.error("Error browsing for audio file:", error);
              alert("Could not browse for file. Ensure the backend API is running.");
            }
          });

          $("#browse-output").click(async function() {
            try {
              // Call using window.pywebview.api
              const folderPath = await window.pywebview.api.browse_folder();
              // REMOVED sanitizePath call
              if (folderPath) { // Check raw path
                $("#output_path").val(folderPath); // Use raw path
                 console.log("Selected output folder:", folderPath); // Log raw path
              } else {
                console.log("Output folder selection cancelled.");
              }
            } catch (error) {
               console.error("Error browsing for output folder:", error);
              alert("Could not browse for folder. Ensure the backend API is running.");
            }
          });

          $("#browse-beatmap").click(async function() {
            try {
              // Call using window.pywebview.api
              const filePath = await window.pywebview.api.browse_file(); // Use browse_file for beatmap
              // REMOVED sanitizePath call
              if (filePath) { // Check raw path
                $("#beatmap_path").val(filePath); // Use raw path
                console.log("Selected beatmap file:", filePath); // Log raw path
                // Trigger the input event manually to update the UI
                $("#beatmap_path").trigger('input'); 
              } else {
                console.log("Beatmap file selection cancelled.");
              }
            } catch (error) {
              console.error("Error browsing for beatmap file:", error);
              alert("Could not browse for file. Ensure the backend API is running.");
            }
          });

        }); // End of pywebviewready listener
        // --- End Browse Button Logic ---

        // --- In-Context Dropdown Logic ---
        const $beatmapPathInput = $('#beatmap_path');
        const $inContextOptionsBox = $('#in-context-options-box'); // Renamed variable
        const $contextCheckboxes = $inContextOptionsBox.find('input[name="in_context_options"]');
        const $noneCheckbox = $('#context-none');
        const animationSpeed = 300; // ms
        const $addToBeatmapOption = $('#add-to-beatmap-option'); // Cache the option div

        // Show/Hide options box based on input content
        $beatmapPathInput.on('input', function() {
          if ($(this).val().trim() !== '') {
            if (!$inContextOptionsBox.is(':visible')) {
              $inContextOptionsBox.fadeIn(animationSpeed);
            }
            if (!$addToBeatmapOption.is(':visible')) {
              $addToBeatmapOption.slideDown(animationSpeed);
            }
          } else {
            if ($inContextOptionsBox.is(':visible')) {
              $inContextOptionsBox.fadeOut(animationSpeed);
            }
            if ($addToBeatmapOption.is(':visible')) {
              $addToBeatmapOption.slideUp(animationSpeed);
              $('#add_to_beatmap').prop('checked', false); // Uncheck when hidden
            }
          }
        });

        // Handle checkbox interactions
        $contextCheckboxes.on('change', function() {
            const $changedCheckbox = $(this);
            const isNoneChecked = $noneCheckbox.is(':checked');
            const $otherCheckboxes = $contextCheckboxes.not($noneCheckbox);
            const $otherChecked = $otherCheckboxes.filter(':checked');

            // Disable all checkboxes temporarily during processing to prevent race conditions
            $contextCheckboxes.prop('disabled', true);

            if ($changedCheckbox.is($noneCheckbox)) {
                // If 'None' was just checked
                if (isNoneChecked) {
                    $otherCheckboxes.prop('checked', false); // Uncheck others
                    // Disable other checkboxes *before* animation
                    $otherCheckboxes.prop('disabled', true);
                    $otherCheckboxes.closest('.context-option-item').slideUp(animationSpeed, function() {
                        // Re-enable only the 'None' checkbox after animation
                        $noneCheckbox.prop('disabled', false);
                    });
                } else {
                    // If 'None' was just unchecked, show and enable others
                    $otherCheckboxes.closest('.context-option-item').slideDown(animationSpeed, function() {
                        // Enable others and 'None' after animation
                         $contextCheckboxes.prop('disabled', false);
                    });
                }
            } else {
                // If another checkbox was just changed
                if ($changedCheckbox.is(':checked')) {
                    // If another was checked, ensure 'None' is unchecked and disabled, then hide
                    $noneCheckbox.prop('checked', false);
                    $noneCheckbox.prop('disabled', true); // Disable None immediately
                    $noneCheckbox.closest('.context-option-item').fadeOut(animationSpeed, function() {
                         // Re-enable the other checkboxes after fade out
                         $otherCheckboxes.prop('disabled', false);
                         // $changedCheckbox is already enabled as it triggered the event
                    });
                } else {
                    // If another was unchecked, check if any others are still checked
                    if ($otherChecked.length === 0) {
                       // If no others are checked, show and enable 'None' again
                       $noneCheckbox.closest('.context-option-item').fadeIn(animationSpeed, function() {
                           $noneCheckbox.prop('disabled', false); // Enable None after fade in
                           // Ensure other checkboxes are also enabled
                           $otherCheckboxes.prop('disabled', false);
                       });
                    } else {
                        // If others are still checked, just re-enable the checkboxes
                         $contextCheckboxes.prop('disabled', false);
                    }
                }
            }
        });
        // Ensure initial state is correct (e.g., if loaded with pre-filled data)
        // This might need adjustment based on how form state is persisted
        if ($contextCheckboxes.not($noneCheckbox).is(':checked')) {
            $noneCheckbox.prop('checked', false).closest('.context-option-item').hide();
        } else if ($noneCheckbox.is(':checked')) {
            $contextCheckboxes.not($noneCheckbox).prop('checked', false).closest('.context-option-item').hide();
        }
        // --- End In-Context Dropdown Logic ---

        // --- Prevent Number Input Scroll/Arrows (except Year) ---
        $('input[type="number"]').not('#year').each(function() {
          // Disable mouse wheel
          $(this).on('wheel', function(e) {
            e.preventDefault();
          });

          // Disable arrow keys (up/down)
          $(this).on('keydown', function(e) {
            if (e.key === "ArrowUp" || e.key === "ArrowDown") {
              e.preventDefault();
            }
          });
        });
        // --- End Number Input Scroll/Arrows Prevention ---

        // --- Gamemode Conditional Visibility ---
        function updateOptionalSettingsVisibility() {
          var selectedGamemode = $("#gamemode").val(); // Get the string value ('0', '1', '2', '3')
          var animationSpeed = 200; // Speed in milliseconds (e.g., 200 for a quick slide)
          var $circleSizeInput = $("#circle_size");
          var $circleSizeAsterisk = $(".cs-required");
          var $keyCountInput = $("#keycount");
          var $keyCountAsterisk = $(".kc-required");

          // Determine which groups should be visible
          var showCircleSize = (selectedGamemode === '0');
          var showKeyCount = (selectedGamemode === '3');
          var showHoldNoteRatio = (selectedGamemode === '3');
          var showScrollSpeed = (selectedGamemode === '2' || selectedGamemode === '3');

          // Animate Circle Size and manage required attribute
          if (showCircleSize) {
              if (!$("#group-circle_size").is(':visible')) {
                 $("#group-circle_size").slideDown(animationSpeed);
              }
              $circleSizeInput.prop('required', true); // Set as required
              $circleSizeAsterisk.show();           // Show asterisk
          } else {
              if ($("#group-circle_size").is(':visible')) {
                  $("#group-circle_size").slideUp(animationSpeed);
              }
              $circleSizeInput.prop('required', false); // Remove required
              $circleSizeInput.val(''); // Clear value when hidden
              $circleSizeAsterisk.hide();            // Hide asterisk
          }

          // Animate Key Count and manage required attribute
          if (showKeyCount) {
              if (!$("#group-keycount").is(':visible')) {
                  $("#group-keycount").slideDown(animationSpeed);
              }
              $keyCountInput.prop('required', true); // Set as required
              $keyCountAsterisk.show();          // Show asterisk
          } else {
              if ($("#group-keycount").is(':visible')) {
                  $("#group-keycount").slideUp(animationSpeed);
              }
              $keyCountInput.prop('required', false); // Remove required
              $keyCountInput.val(''); // Clear value when hidden
              $keyCountAsterisk.hide();           // Hide asterisk
          }

          // Animate Hold Note Ratio
          if (showHoldNoteRatio && !$("#group-hold_note_ratio").is(':visible')) {
            $("#group-hold_note_ratio").slideDown(animationSpeed);
          } else if (!showHoldNoteRatio && $("#group-hold_note_ratio").is(':visible')) {
            $("#group-hold_note_ratio").slideUp(animationSpeed);
          }

          // Animate Scroll Speed Ratio
          if (showScrollSpeed && !$("#group-scroll_speed_ratio").is(':visible')) {
            $("#group-scroll_speed_ratio").slideDown(animationSpeed);
          } else if (!showScrollSpeed && $("#group-scroll_speed_ratio").is(':visible')) {
            $("#group-scroll_speed_ratio").slideUp(animationSpeed);
          }
        }

        // Initial call on page load (run without animation initially)
        updateOptionalSettingsVisibility();

        // Attach change listener to gamemode select
        $("#gamemode").on('change', updateOptionalSettingsVisibility);
        // --- End Gamemode Conditional Visibility ---

        // --- Descriptor Checkbox 3-State Logic ---
        $('.descriptors-container').on('click', 'input[name="descriptors"]', function(e) {
            var $checkbox = $(this);

            // Prevent default checkbox behavior as we manage state manually
            e.preventDefault();

            if ($checkbox.hasClass('positive-check')) {
                // State: Positive -> Negative
                $checkbox.removeClass('positive-check').addClass('negative-check');
                $checkbox.prop('checked', true); // Keep it technically 'checked' for form data
                console.log($checkbox.val() + ' set to negative');
            } else if ($checkbox.hasClass('negative-check')) {
                // State: Negative -> Off
                $checkbox.removeClass('negative-check');
                $checkbox.prop('checked', false);
                console.log($checkbox.val() + ' set to off');
            } else {
                // State: Off -> Positive
                $checkbox.addClass('positive-check');
                $checkbox.prop('checked', true);
                console.log($checkbox.val() + ' set to positive');
            }
        });
        // --- End Descriptor Checkbox Logic ---

        // --- Form Submission & Progress Handling ---
        var evtSource = null; // Keep track of the EventSource
        var isCancelled = false; // Flag to track cancellation
        let inferenceErrorOccurred = false; // New flag for error state
        let accumulatedErrorMessages = []; // New buffer for error messages

        // Function to display flash messages
        function showFlashMessage(message, type = 'success') {
            const flashContainer = $('#flash-container');
            // Determine class based on type
            let alertClass = 'alert ';
            if (type === 'success') {
                alertClass += 'success';
            } else if (type === 'error') {
                alertClass += 'error';
            } else if (type === 'cancel-success') {
                alertClass += 'alert-cancel-success'; // Use the new custom class
            } else { 
                alertClass += 'success'; // Default to success style
            }

            const messageDiv = $('<div class="' + alertClass + '">' + message + '</div>');
            flashContainer.append(messageDiv);
            
            // Set timeout for automatic removal based on CSS animation
            setTimeout(() => {
                messageDiv.remove();
            }, 5000); // Match total animation time (slide in + visible + fade out)
        }

        $("#inferenceForm").submit(function(e) {
          // --- Validation Step ---           
          const audioPath = $('#audio_path').val().trim();
          const beatmapPath = $('#beatmap_path').val().trim();
          
          if (!audioPath && !beatmapPath) {
              e.preventDefault(); // Stop the form submission
              $('html, body').animate({ scrollTop: 0 }, 500); // Scroll to top
              showFlashMessage("Either 'Beatmap Path' or 'Audio Path' are required for running inference", 'error');
              return; // Exit the submit handler
          }
          // --- End Validation Step ---

          e.preventDefault(); // Prevent default form submission (moved after validation)

          // Clear previous flash messages
          $('#flash-container').empty();
          // Clear previous cancellation messages within progress box (belt and suspenders)
          $("#progress_output .cancellation-message").remove();

          // Reset UI
          $("#progress_output").show(); // Make sure progress box is shown initially
          // Scroll down to the progress box
          $('html, body').animate({ scrollTop: $('#progress_output').offset().top }, 500); 

          $("#progressBarContainer").show(); // Ensure these are visible on start
          $("#progressTitle").show();
          $("#progressBar").css("width", "0%").removeClass('cancelled'); // Reset progress bar
          $("#beatmapLink").hide();
          $("#init_message").text("Initializing process... This may take a moment.").show(); // Show init message
          $("#progressTitle").text("");
          $("#cancel-button").hide().prop('disabled', false).text('Cancel'); // Reset cancel button

          // Disable Run button, enable/show Cancel button after short delay
          var $submitButton = $("button[type='submit']");
          var $cancelButton = $("#cancel-button");
          $submitButton.prop("disabled", true);
          
          // Reset error state and buffer
          inferenceErrorOccurred = false;
          accumulatedErrorMessages = [];
          $("#progressBar").removeClass('error'); // Ensure error class is removed initially
          $("#progressTitle").css('color', ''); // Reset title color

          // Clear previous EventSource if it exists
          if (evtSource) {
            evtSource.close();
            evtSource = null;
            console.log("Closed previous SSE stream.");
          }

          // Use AJAX to POST form data to the Flask backend
          $.ajax({
            url: "/start_inference", // Flask endpoint
            method: "POST",
            data: function() {
                var formData = new FormData($("#inferenceForm")[0]); // Use FormData for easier handling

                // Clear existing descriptors and prepare lists
                formData.delete('descriptors');
                var positiveDescriptors = [];
                var negativeDescriptors = [];

                // Iterate over descriptor checkboxes
                $('input[name="descriptors"]').each(function() {
                    var $cb = $(this);
                    if ($cb.hasClass('positive-check')) {
                        positiveDescriptors.push($cb.val());
                    } else if ($cb.hasClass('negative-check')) {
                        negativeDescriptors.push($cb.val());
                    }
                });

                // Add collected descriptors to FormData using traditional submission format
                positiveDescriptors.forEach(function(val) {
                  formData.append('descriptors', val);
                });
                negativeDescriptors.forEach(function(val) {
                  formData.append('negative_descriptors', val);
                });

                // --- Add In-Context Options ---
                // REMOVED redundant block that manually appended in_context_options
                // --- End Add In-Context Options ---

                // Debug: Log FormData contents before sending
                // for (var pair of formData.entries()) {
                //    console.log(pair[0]+ ', ' + pair[1]);
                // }

                return formData;
            }(),
            processData: false, // Important: Prevent jQuery from processing the FormData
            contentType: false, // Important: Let the browser set the correct content type
            success: function() {
              // If POST is successful, show Cancel button and start listening for SSE
              $cancelButton.show(); 
              var audioPath = $("#audio_path").val() || "audio file"; 
              console.log("Inference started. Connecting to SSE stream...");
              evtSource = new EventSource("/stream_output"); // Flask SSE endpoint

              evtSource.onmessage = function(e) {
                 // Hide init message once data arrives
                if ($("#init_message").is(":visible")) { $("#init_message").hide(); }
                if (isCancelled) return; // Ignore messages after cancellation is confirmed

                console.log("SSE Data:", e.data);
                const messageData = e.data; // Store for easier access

                // Check for error indicators FIRST
                const errorIndicators = [
                    "Traceback (most recent call last):",
                    "Error executing job with overrides:",
                    "FileNotFoundError:",
                    "Exception:", // General Python exception marker
                    "Set the environment variable HYDRA_FULL_ERROR=1" // Hydra specific
                ];

                // Check if the current message indicates an error
                let isErrorMessage = errorIndicators.some(indicator => messageData.includes(indicator));

                if (isErrorMessage && !inferenceErrorOccurred) {
                    // First time encountering an error message in this stream
                    console.warn("Error detected in SSE stream.");
                    inferenceErrorOccurred = true;
                    accumulatedErrorMessages.push(messageData); // Add the first error message
                    // Update UI immediately to indicate error
                    $("#progressTitle").text("Error Detected").css('color', 'var(--accent-color)'); // Use accent color for error text
                    $("#progressBar").addClass('error'); // Add class for styling (e.g., red color)
                    // Hide normal progress elements if needed, or let them continue but styled differently

                } else if (inferenceErrorOccurred) {
                    // Already in error state, accumulate all subsequent messages
                    accumulatedErrorMessages.push(messageData);

                } else {
                    // Check for title keywords (case-insensitive)
                    const lowerCaseMessage = messageData.toLowerCase();
                    let newTitle = null;

                    if (lowerCaseMessage.includes("generating timing")) {
                        newTitle = "Generating Timing";
                    } else if (lowerCaseMessage.includes("generating kiai")) {
                        newTitle = "Generating Kiai";
                    } else if (lowerCaseMessage.includes("generating map")) {
                        newTitle = "Generating Map";
                    } else if (lowerCaseMessage.includes("seq len")) {
                        newTitle = "Refining Positions"; // Or customize further if needed
                    }

                    if (newTitle) {
                        $("#progressTitle").text(newTitle);
                    }

                    // --- Normal Progress Processing (Only if no error has occurred) ---
                    var progressMatch = messageData.match(/^\s*(\d+)%\|/);
                    if (progressMatch) {
                      var currentPercent = parseInt(progressMatch[1].trim(), 10);

                      if (!isNaN(currentPercent)) {
                         // Update progress bar width only if no error occurred
                         // Note: progressBar styling might be handled by the .error class instead
                         $("#progressBar").css("width", currentPercent + "%");
                      }

                    } else if (messageData.includes("Generated beatmap saved to")) {
                      // Handle beatmap generation message (unchanged from original)
                      var beatmapLine = messageData.trim();
                      var parts = beatmapLine.split("Generated beatmap saved to");
                      if (parts.length > 1) {
                        var fullPath = parts[1].trim();
                        fullPath = fullPath.replace(/\\/g, "/"); // Normalize path
                        var folderPath = fullPath.substring(0, fullPath.lastIndexOf("/"));

                        // Update the link to use the folder path and trigger Flask endpoint
                        $("#beatmapLinkAnchor")
                          .attr("href", "#") // Keep as non-navigating link
                          .text("Click here to open the folder containing your map.")
                          .off("click") // Remove previous handlers
                          .on("click", function(clickEvent) {
                            clickEvent.preventDefault();
                            console.log("Requesting folder open via Flask:", folderPath);
                            // Use GET request to Flask endpoint to open folder
                            $.get("/open_folder", { folder: folderPath })
                              .done(function(response) {
                                console.log("Open folder response:", response);
                              })
                              .fail(function() {
                                alert("Failed to open folder via backend.");
                              });
                          });
                        $("#beatmapLink").show(); // Show the link div
                      }
                    }
                }
              }; // End of evtSource.onmessage

              evtSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                if (evtSource) evtSource.close();
                evtSource = null;
                // Also indicate an error if the stream itself fails unexpectedly
                if (!isCancelled && !inferenceErrorOccurred) {
                   inferenceErrorOccurred = true; // Mark as error
                   accumulatedErrorMessages.push("Error: Connection to process stream lost.");
                   // Update UI to reflect connection error
                   $("#progressTitle").text("Connection Error").css('color', 'var(--accent-color)');
                   $("#progressBar").addClass('error');
                   showFlashMessage("Error: Connection to process stream lost.", "error");
                }
                if (!isCancelled) { // Only re-enable if not cancelled
                   $submitButton.prop("disabled", false);
                }
                $cancelButton.hide(); // Hide cancel on error too
              };

              // Listen for the custom 'end' event from Flask
              evtSource.addEventListener("end", function(e) {
                console.log("Received end event from server.", e.data);
                if (evtSource) evtSource.close();
                evtSource = null;

                if (isCancelled) {
                    // Cancellation Path: UI is handled by cancel AJAX success (flash message).
                    // Ensure progress elements are hidden or reset.
                    console.log("SSE End event received after cancellation.");
                     $("#progressTitle").hide();
                     $("#progressBarContainer").hide();
                     $("#beatmapLink").hide();

                } else if (inferenceErrorOccurred) {
                    // Error Occurred Path
                    console.error("Process finished with errors.");
                    // --- Simple Error Parsing ---
                    let specificError = "An error occurred during processing. Check console/logs."; // Default
                    const fullErrorText = accumulatedErrorMessages.join("\\n"); // Use newline for searching

                    if (fullErrorText.includes("FileNotFoundError:")) {
                         // Try to extract the filename if possible
                         const fileNotFoundMatch = fullErrorText.match(/FileNotFoundError:.*? file (.*?) not found/);
                         if (fileNotFoundMatch && fileNotFoundMatch[1]) {
                             specificError = `Error: File not found - ${fileNotFoundMatch[1].replace(/\\\\/g, '\\\\')}`; // Basic path unescaping for display
                         } else {
                              specificError = "Error: A required file was not found.";
                         }
                    } else if (fullErrorText.includes("HYDRA_FULL_ERROR=1")) {
                        // Use the user-suggested message
                        specificError = "There was an error while creating the beatmap. Check console/logs for details.";
                    } else if (fullErrorText.includes("Error executing job")) {
                         specificError = "There was an error starting or executing the generation task.";
                    } else if (fullErrorText.includes("Connection to process stream lost")) {
                        // Handle the connection error case specifically if needed, though caught by onerror too
                        specificError = "Error: Connection to the generation process was lost.";
                    }
                    // --- End Simple Error Parsing ---

                    // Display error message prominently using flash message
                     showFlashMessage(specificError, "error");

                    // Update progress area to show final failure state
                    $("#progressTitle").text("Processing Failed").css('color', 'var(--accent-color)').show();
                    $("#progressBar").css("width", "100%").addClass('error'); // Show full bar in error color
                    $("#progressBarContainer").show(); // Ensure container is visible
                    $("#beatmapLink").hide(); // Hide success link

                } else {
                    // Normal Completion Path
                     $("#progressTitle").show().text("Processing Complete").css('color', ''); // Reset color
                     $("#progressBarContainer").show();
                     $("#progressBar").css("width", "100%").removeClass('error'); // Ensure error class removed
                    // Beatmap link visibility is handled by the onmessage handler if successful
                }

                $submitButton.prop("disabled", false); // Re-enable Run button
                $cancelButton.hide(); // Hide Cancel button

                // Reset flags for the next run AFTER handling the end event
                isCancelled = false;
                inferenceErrorOccurred = false;
                accumulatedErrorMessages = []; // Clear buffer

              });

            }, // End of AJAX success
            error: function(jqXHR, textStatus, errorThrown) {
              // Handle AJAX error (failed to start inference)
              console.error("Failed to start inference:", textStatus, errorThrown);
              alert("Failed to start inference process. Check backend console.");
              $submitButton.prop("disabled", false); // Re-enable Run button
              $cancelButton.hide(); // Ensure cancel button is hidden
              $("#progress_output").hide(); // Hide progress section on startup error
            }
          }); // End of AJAX call
        }); // End of form submit handler

        // --- Cancel Button Click Handler ---
        $("#cancel-button").click(function() {
            var $cancelBtn = $(this);
            $cancelBtn.prop('disabled', true).text('Cancelling...');
            console.log("Sending cancel request...");

            $.ajax({
                url: "/cancel_inference",
                method: "POST",
                success: function(response) {
                    console.log("Cancel request successful:", response.message);
                    isCancelled = true; // Set flag early
                    // Hide the main progress box
                    $("#progress_output").hide(); 
                    // Show the flash message popup using the custom style type
                    showFlashMessage("Inference cancelled successfully.", "cancel-success");
                    // The SSE 'end' event will still fire to re-enable Run button & reset state.
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Cancel request failed:", textStatus, errorThrown);
                    const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : "Failed to send cancel request. Unknown error.";
                    showFlashMessage(errorMsg, "error"); // Use standard error style
                    // Re-enable cancel button ONLY if the request failed, allowing retry
                    $cancelBtn.prop('disabled', false).text('Cancel'); 
                }
            });
        });
        // --- End Cancel Button Click Handler ---

      }); // End of document ready
    </script>
  </body>
</html>